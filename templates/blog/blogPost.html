{% extends "base.html" %}

{% block title %} {{ post.title }} - VELBLOG {% endblock title %}
{% load humanize %}

{% block body %}
<div class="container animate-fade-in" style="max-width: 850px; margin-top: 40px;">

  <article class="mb-4">
    <div class="blog-header">
      <h1 class="mb-4">{{ post.title }}</h1>
      <div class="blog-meta-row">
        <span><i class="fas fa-user"></i> {{ post.author }}</span>
        <span><i class="fas fa-calendar"></i> {{ post.timeStamp }}</span>
        <span><i class="fas fa-eye"></i> {{ post.views }} VIEWS</span>
      </div>
    </div>

    <div class="blog-content">
      {{ post.content | safe }}
    </div>
  </article>

  <div class="comment-section">
    <h3 class="mb-4 text-center">Discussion ({{ comments.count }})</h3>

    {% if user.is_authenticated %}
    <form method="POST" action="/blog/postComment" class="mb-4">
      {% csrf_token %}
      <div class="form-group">
        <textarea name="comment" rows="3" placeholder="CONTRIBUTE YOUR THOUGHTS..." required></textarea>
      </div>
      <input type="hidden" name="sno" value="{{ post.sno }}">
      <div class="flex justify-between items-center">
        <small class="text-secondary">Logged in as {{ user.username }}</small>
        <button type="submit" class="btn btn-primary" style="width: 200px;">POST COMMENT</button>
      </div>
    </form>
    {% else %}
    <div class="alert text-center">
      MEMBERS ONLY. PLEASE <a href="/login"
        style="text-decoration: underline; font-weight: bold; color: var(--text-main);">LOGIN</a> TO COMMENT.
    </div>
    {% endif %}

    <div class="comments-list">
      {% for comment in comments %}
      <div class="comment-item">
        <div class="flex" style="align-items: flex-start;">
          <div class="comment-avatar">
            {{ comment.user.username|make_list|first|upper }}
          </div>
          <div style="flex-grow: 1;">
            <div class="flex justify-between mb-2">
              <strong style="text-transform: uppercase;">{{ comment.user.username }}</strong>
              <small class="text-secondary">{{ comment.timestamp|naturaltime }}</small>
            </div>

            <p class="mb-2" style="font-size: 1rem; color: #333;">{{ comment.comment }}</p>

            <div class="flex" style="gap: 15px; margin-top: 10px;">
              {% if user.is_authenticated %}
              <button class="btn" style="padding: 5px 12px; font-size: 0.75rem; border: 1px solid #ccc;"
                onclick="toggleReply('replyBox{{ comment.sno }}')">
                <i class="fas fa-reply"></i> REPLY
              </button>
              {% endif %}

              {% if comment.replies.count > 0 %}
              <button class="btn"
                style="padding: 5px 12px; font-size: 0.75rem; border: none; text-decoration: underline;"
                onclick="toggleReply('replies-{{ comment.sno }}')">
                VIEW REPLIES ({{ comment.replies.count }})
              </button>
              {% endif %}
            </div>

            <!-- Reply Form -->
            <div id="replyBox{{ comment.sno }}"
              style="display: none; margin-top: 20px; background: #fafafa; padding: 20px; border-radius: 8px;">
              <form method="POST" action="/blog/postComment">
                {% csrf_token %}
                <input type="hidden" name="sno" value="{{ post.sno }}">
                <input type="hidden" name="parentSno" value="{{ comment.sno }}">
                <div class="form-group">
                  <input type="text" name="comment" placeholder="WRITE A REPLY..." required>
                </div>
                <button type="submit" class="btn btn-primary" style="padding: 10px 20px; font-size: 0.8rem;">SUBMIT
                  REPLY</button>
              </form>
            </div>

            <!-- Replies List -->
            <div id="replies-{{ comment.sno }}" style="display: none; margin-top: 20px; padding-left: 0;">
              {% for reply in comment.replies.all %}
              <div style="margin-bottom: 20px; padding-left: 20px; border-left: 2px solid #eee; margin-left: 5px;">
                <div class="flex justify-between mb-1">
                  <strong style="font-size: 0.9rem; text-transform: uppercase;">{{ reply.user.username }}</strong>
                  <small class="text-secondary" style="font-size: 0.8rem;">{{ reply.timestamp|naturaltime }}</small>
                </div>
                <p style="font-size: 0.95rem;">{{ reply.comment }}</p>
              </div>
              {% endfor %}
            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>

  </div>
</div>

<script>
  function toggleReply(id) {
    var x = document.getElementById(id);
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }
  }
</script>
{% endblock body %}